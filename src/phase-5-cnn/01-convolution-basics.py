"""
01-convolution-basics.py - å·ç§¯æ“ä½œåŸºç¡€

æœ¬èŠ‚å­¦ä¹ å†…å®¹ï¼š
1. ä»€ä¹ˆæ˜¯å·ç§¯æ“ä½œ
2. å·ç§¯æ ¸ï¼ˆæ»¤æ³¢å™¨ï¼‰çš„ä½œç”¨
3. æ­¥é•¿ï¼ˆStrideï¼‰å’Œå¡«å……ï¼ˆPaddingï¼‰
4. è¾“å‡ºå°ºå¯¸è®¡ç®—å…¬å¼
5. å¤šé€šé“å·ç§¯
"""

import torch
import torch.nn as nn
import torch.nn.functional as F
import matplotlib.pyplot as plt
import numpy as np

print("=" * 60)
print("ç¬¬1èŠ‚: å·ç§¯æ“ä½œåŸºç¡€")
print("=" * 60)

# ============================================================
# 1. ä»€ä¹ˆæ˜¯å·ç§¯
# ============================================================
print("\nğŸ“Œ 1. å·ç§¯æ“ä½œçš„ç›´è§‚ç†è§£")
print("-" * 40)

# åˆ›å»ºä¸€ä¸ªç®€å•çš„5x5è¾“å…¥å›¾åƒ
input_image = torch.tensor([
    [1., 0., 1., 0., 1.],
    [0., 1., 0., 1., 0.],
    [1., 0., 1., 0., 1.],
    [0., 1., 0., 1., 0.],
    [1., 0., 1., 0., 1.]
]).unsqueeze(0).unsqueeze(0)  # æ·»åŠ batchå’Œchannelç»´åº¦: [1, 1, 5, 5]

print(f"è¾“å…¥å›¾åƒå½¢çŠ¶: {input_image.shape}")
print(f"è¾“å…¥å›¾åƒ:\n{input_image.squeeze()}")

# åˆ›å»ºä¸€ä¸ª3x3å·ç§¯æ ¸
kernel = torch.tensor([
    [1., 0., 1.],
    [0., 1., 0.],
    [1., 0., 1.]
]).unsqueeze(0).unsqueeze(0)  # [1, 1, 3, 3]

print(f"\nå·ç§¯æ ¸ (3Ã—3):\n{kernel.squeeze()}")

# æ‰‹åŠ¨è®¡ç®—ç¬¬ä¸€ä¸ªä½ç½®çš„å·ç§¯ç»“æœ
print("\næ‰‹åŠ¨è®¡ç®—ç¬¬ä¸€ä¸ªä½ç½® (0,0) çš„å·ç§¯:")
first_region = input_image[0, 0, 0:3, 0:3]
print(f"è¾“å…¥åŒºåŸŸ:\n{first_region}")
conv_result = (first_region * kernel.squeeze()).sum()
print(f"å·ç§¯ç»“æœ: {first_region} âŠ™ kernel = {conv_result.item()}")

# ä½¿ç”¨F.conv2dè¿›è¡Œå·ç§¯
output = F.conv2d(input_image, kernel, stride=1, padding=0)
print(f"\nä½¿ç”¨ F.conv2d çš„å®Œæ•´è¾“å‡º (shape: {output.shape}):\n{output.squeeze()}")

# ============================================================
# 2. æ­¥é•¿ (Stride)
# ============================================================
print("\nğŸ“Œ 2. æ­¥é•¿ (Stride) çš„å½±å“")
print("-" * 40)

# åˆ›å»º8x8è¾“å…¥
large_input = torch.randn(1, 1, 8, 8)
print(f"è¾“å…¥å½¢çŠ¶: {large_input.shape}")

# ä¸åŒæ­¥é•¿çš„è¾“å‡º
for stride in [1, 2, 3]:
    output = F.conv2d(large_input, kernel, stride=stride, padding=0)
    print(f"Stride={stride}: è¾“å‡ºå½¢çŠ¶ {output.shape}")

print("""
æ­¥é•¿è§£é‡Š:
- Stride=1: å·ç§¯æ ¸æ¯æ¬¡ç§»åŠ¨1ä¸ªåƒç´ 
- Stride=2: å·ç§¯æ ¸æ¯æ¬¡ç§»åŠ¨2ä¸ªåƒç´ ï¼ˆè¾“å‡ºå°ºå¯¸å‡åŠï¼‰
- Stride=3: å·ç§¯æ ¸æ¯æ¬¡ç§»åŠ¨3ä¸ªåƒç´ 
""")

# ============================================================
# 3. å¡«å…… (Padding)
# ============================================================
print("\nğŸ“Œ 3. å¡«å…… (Padding) çš„ä½œç”¨")
print("-" * 40)

input_5x5 = torch.randn(1, 1, 5, 5)
print(f"è¾“å…¥å½¢çŠ¶: {input_5x5.shape}")

# ä¸åŒå¡«å……çš„è¾“å‡º
for padding in [0, 1, 2]:
    output = F.conv2d(input_5x5, kernel, stride=1, padding=padding)
    print(f"Padding={padding}: è¾“å‡ºå½¢çŠ¶ {output.shape}")

print("""
å¡«å……è§£é‡Š:
- Padding=0 (Valid): ä¸å¡«å……ï¼Œè¾“å‡ºå˜å°
- Padding=1 (Same): å¡«å……1åœˆ0ï¼Œ3x3æ ¸æ—¶ä¿æŒåŸå°ºå¯¸
- Padding=2: å¡«å……2åœˆ0ï¼Œè¾“å‡ºå˜å¤§
""")

# ============================================================
# 4. è¾“å‡ºå°ºå¯¸è®¡ç®—å…¬å¼
# ============================================================
print("\nğŸ“Œ 4. è¾“å‡ºå°ºå¯¸è®¡ç®—å…¬å¼")
print("-" * 40)

def calc_output_size(W, K, P, S):
    """
    è®¡ç®—å·ç§¯è¾“å‡ºå°ºå¯¸
    W: è¾“å…¥å°ºå¯¸
    K: å·ç§¯æ ¸å°ºå¯¸
    P: å¡«å……å¤§å°
    S: æ­¥é•¿
    """
    return (W - K + 2 * P) // S + 1

print("å…¬å¼: Output = floor((W - K + 2P) / S) + 1")
print("\nç¤ºä¾‹è®¡ç®—:")

examples = [
    (32, 3, 1, 1),   # 32x32è¾“å…¥, 3x3æ ¸, padding=1, stride=1
    (32, 5, 0, 1),   # 32x32è¾“å…¥, 5x5æ ¸, padding=0, stride=1
    (224, 7, 3, 2),  # 224x224è¾“å…¥, 7x7æ ¸, padding=3, stride=2 (å¸¸è§ç¬¬ä¸€å±‚)
    (56, 3, 1, 2),   # 56x56è¾“å…¥, 3x3æ ¸, padding=1, stride=2 (é™é‡‡æ ·)
]

for W, K, P, S in examples:
    output = calc_output_size(W, K, P, S)
    print(f"W={W}, K={K}, P={P}, S={S} â†’ Output={output}")

# ============================================================
# 5. å¤šé€šé“å·ç§¯
# ============================================================
print("\nğŸ“Œ 5. å¤šé€šé“å·ç§¯")
print("-" * 40)

# RGBå›¾åƒ: 3é€šé“è¾“å…¥
rgb_input = torch.randn(1, 3, 32, 32)  # [batch, channels, H, W]
print(f"RGBè¾“å…¥å½¢çŠ¶: {rgb_input.shape}")

# å®šä¹‰Conv2då±‚
conv_layer = nn.Conv2d(
    in_channels=3,    # RGB 3é€šé“
    out_channels=16,  # 16ä¸ªå·ç§¯æ ¸
    kernel_size=3,    # 3x3å·ç§¯æ ¸
    stride=1,
    padding=1
)

output = conv_layer(rgb_input)
print(f"è¾“å‡ºå½¢çŠ¶: {output.shape}")
print(f"\nå·ç§¯æ ¸æƒé‡å½¢çŠ¶: {conv_layer.weight.shape}")
print(f"è§£é‡Š: [out_channels, in_channels, kernel_H, kernel_W]")
print(f"      = [16, 3, 3, 3]")
print(f"      æ¯ä¸ªè¾“å‡ºé€šé“æœ‰ä¸€ä¸ª 3Ã—3Ã—3 çš„å·ç§¯æ ¸")

# ============================================================
# 6. ä½¿ç”¨PyTorchçš„Conv2då±‚
# ============================================================
print("\nğŸ“Œ 6. PyTorch Conv2d å‚æ•°è¯¦è§£")
print("-" * 40)

# åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„å·ç§¯å±‚
conv = nn.Conv2d(
    in_channels=3,      # è¾“å…¥é€šé“æ•°
    out_channels=64,    # è¾“å‡ºé€šé“æ•°ï¼ˆå·ç§¯æ ¸æ•°é‡ï¼‰
    kernel_size=3,      # å·ç§¯æ ¸å¤§å°ï¼ˆå¯ä»¥æ˜¯tupleå¦‚(3,5)ï¼‰
    stride=1,           # æ­¥é•¿
    padding=1,          # å¡«å……
    dilation=1,         # ç©ºæ´å·ç§¯çš„è†¨èƒ€ç‡
    groups=1,           # åˆ†ç»„å·ç§¯
    bias=True           # æ˜¯å¦ä½¿ç”¨åç½®
)

print(f"Conv2då±‚å‚æ•°:")
print(f"  in_channels:  {conv.in_channels}")
print(f"  out_channels: {conv.out_channels}")
print(f"  kernel_size:  {conv.kernel_size}")
print(f"  stride:       {conv.stride}")
print(f"  padding:      {conv.padding}")

# å‚æ•°æ•°é‡
num_params = sum(p.numel() for p in conv.parameters())
print(f"\nå‚æ•°æ€»æ•°: {num_params}")
print(f"  æƒé‡: {conv.weight.numel()} = 64 Ã— 3 Ã— 3 Ã— 3 = {64*3*3*3}")
print(f"  åç½®: {conv.bias.numel()} = 64")

# ============================================================
# 7. å¯è§†åŒ–å·ç§¯æ•ˆæœ
# ============================================================
print("\nğŸ“Œ 7. å¸¸è§å·ç§¯æ ¸çš„æ•ˆæœ")
print("-" * 40)

# å®šä¹‰å¸¸ç”¨å·ç§¯æ ¸
kernels = {
    "æ’ç­‰": torch.tensor([[0., 0., 0.],
                         [0., 1., 0.],
                         [0., 0., 0.]]),
    "è¾¹ç¼˜æ£€æµ‹": torch.tensor([[-1., -1., -1.],
                             [-1.,  8., -1.],
                             [-1., -1., -1.]]),
    "é”åŒ–": torch.tensor([[ 0., -1.,  0.],
                         [-1.,  5., -1.],
                         [ 0., -1.,  0.]]),
    "æ¨¡ç³Š": torch.tensor([[1., 1., 1.],
                         [1., 1., 1.],
                         [1., 1., 1.]]) / 9,
    "Sobel-X": torch.tensor([[-1., 0., 1.],
                             [-2., 0., 2.],
                             [-1., 0., 1.]]),
    "Sobel-Y": torch.tensor([[-1., -2., -1.],
                             [ 0.,  0.,  0.],
                             [ 1.,  2.,  1.]]),
}

for name, k in kernels.items():
    print(f"\n{name}å·ç§¯æ ¸:")
    print(k.numpy())

# ============================================================
# 8. å®é™…åº”ç”¨ï¼šè¾¹ç¼˜æ£€æµ‹ç¤ºä¾‹
# ============================================================
print("\nğŸ“Œ 8. è¾¹ç¼˜æ£€æµ‹å®ä¾‹")
print("-" * 40)

# åˆ›å»ºä¸€ä¸ªç®€å•çš„å›¾åƒï¼ˆä¸­é—´æœ‰ä¸€ä¸ªæ–¹å—ï¼‰
simple_image = torch.zeros(1, 1, 16, 16)
simple_image[0, 0, 4:12, 4:12] = 1.0  # ä¸­é—´8x8åŒºåŸŸæ˜¯ç™½è‰²

# Sobelç®—å­
sobel_x = torch.tensor([[-1., 0., 1.],
                        [-2., 0., 2.],
                        [-1., 0., 1.]]).view(1, 1, 3, 3)

# åº”ç”¨Sobelç®—å­
edge_x = F.conv2d(simple_image, sobel_x, padding=1)

print(f"è¾“å…¥å›¾åƒå½¢çŠ¶: {simple_image.shape}")
print(f"è¾¹ç¼˜æ£€æµ‹è¾“å‡ºå½¢çŠ¶: {edge_x.shape}")
print(f"è¾¹ç¼˜æ£€æµ‹å¯ä»¥è¯†åˆ«å›¾åƒä¸­çš„å‚ç›´è¾¹ç¼˜")

# ============================================================
# 9. ç»ƒä¹ 
# ============================================================
print("\n" + "=" * 60)
print("ğŸ’¡ ç»ƒä¹ é¢˜")
print("=" * 60)

print("""
1. è®¡ç®—é¢˜: ä¸€ä¸ª 64Ã—64 çš„è¾“å…¥å›¾åƒï¼Œä½¿ç”¨ 5Ã—5 çš„å·ç§¯æ ¸ï¼Œ
   stride=2ï¼Œpadding=2ï¼Œè¾“å‡ºå°ºå¯¸æ˜¯å¤šå°‘ï¼Ÿ

2. ä»£ç é¢˜: åˆ›å»ºä¸€ä¸ªå·ç§¯å±‚ï¼Œå°† RGB å›¾åƒ (3Ã—224Ã—224) 
   è½¬æ¢ä¸º 32 ä¸ª feature mapsï¼Œä¿æŒç©ºé—´å°ºå¯¸ä¸å˜

3. æ€è€ƒé¢˜: ä¸ºä»€ä¹ˆ 3Ã—3 å·ç§¯æ ¸æ¯” 7Ã—7 æ›´å—æ¬¢è¿ï¼Ÿ

å‚è€ƒç­”æ¡ˆè§è¯¾ä»¶ CONCEPT.md
""")

# ============================================================
# æ€»ç»“
# ============================================================
print("\n" + "=" * 60)
print("ğŸ“ æœ¬èŠ‚è¦ç‚¹æ€»ç»“")
print("=" * 60)

print("""
1. å·ç§¯æ“ä½œ: æ»‘åŠ¨çª—å£ + å…ƒç´ ç›¸ä¹˜æ±‚å’Œ
2. è¾“å‡ºå°ºå¯¸å…¬å¼: (W - K + 2P) / S + 1
3. Padding='same' æ—¶ï¼ŒP = (K-1)/2 å¯ä¿æŒå°ºå¯¸
4. å¤šé€šé“å·ç§¯: æ¯ä¸ªè¾“å‡ºé€šé“å¯¹åº”ä¸€ä¸ª C_in Ã— K Ã— K çš„å·ç§¯æ ¸
5. å‚æ•°æ•°é‡: out_channels Ã— in_channels Ã— K Ã— K + out_channels

ä¸‹ä¸€èŠ‚: æ± åŒ–å±‚ (Pooling Layers)
""")
