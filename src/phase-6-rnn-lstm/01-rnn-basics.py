"""
01-rnn-basics.py - RNN åŸºç¡€ç»“æ„ä¸å‰å‘ä¼ æ’­

æœ¬èŠ‚å­¦ä¹ :
1. ä¸ºä»€ä¹ˆéœ€è¦ RNNï¼Ÿ
2. RNN çš„æ ¸å¿ƒæ€æƒ³
3. æ‰‹åŠ¨å®ç° RNN å‰å‘ä¼ æ’­
4. PyTorch RNN ä½¿ç”¨
"""

import torch
import torch.nn as nn
import numpy as np
import matplotlib.pyplot as plt

plt.rcParams["font.sans-serif"] = ["Arial Unicode MS"]
plt.rcParams["axes.unicode_minus"] = False

print("=" * 60)
print("ç¬¬1èŠ‚: RNN åŸºç¡€ç»“æ„ä¸å‰å‘ä¼ æ’­")
print("=" * 60)

# =============================================================================
# 1. ä¸ºä»€ä¹ˆéœ€è¦ RNNï¼Ÿ
# =============================================================================
print("""
ğŸ“š ä¸ºä»€ä¹ˆéœ€è¦ RNNï¼Ÿ

ä¼ ç»Ÿå‰é¦ˆç¥ç»ç½‘ç»œçš„å±€é™:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å…¥å±‚     éšè—å±‚     è¾“å‡ºå±‚                                 â”‚
â”‚    â—‹         â—‹          â—‹                                    â”‚
â”‚    â—‹    â†’    â—‹    â†’     â—‹                                    â”‚
â”‚    â—‹         â—‹          â—‹                                    â”‚
â”‚                                                              â”‚
â”‚  é—®é¢˜ï¼šæ¯ä¸ªè¾“å…¥ç‹¬ç«‹å¤„ç†ï¼Œæ— æ³•å¤„ç†åºåˆ—å…³ç³»ï¼                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åºåˆ—æ•°æ®çš„ç‰¹ç‚¹:
  "æˆ‘ çˆ± åŒ—äº¬ å¤©å®‰é—¨"
   â†“   â†“   â†“     â†“
   tâ‚  tâ‚‚  tâ‚ƒ    tâ‚„
   
æ¯ä¸ªè¯çš„ç†è§£ä¾èµ–äºå‰é¢çš„ä¸Šä¸‹æ–‡ï¼

åºåˆ—æ•°æ®ç¤ºä¾‹:
  ğŸ“ è‡ªç„¶è¯­è¨€ï¼šå¥å­æ˜¯è¯çš„åºåˆ—
  ğŸµ éŸ³é¢‘ï¼šå£°æ³¢æ˜¯é‡‡æ ·ç‚¹çš„åºåˆ—
  ğŸ“ˆ è‚¡ç¥¨ï¼šä»·æ ¼æ˜¯æ—¶é—´ç‚¹çš„åºåˆ—
  ğŸ§¬ DNAï¼šç¢±åŸºæ˜¯æ ¸è‹·é…¸çš„åºåˆ—
""")

# =============================================================================
# 2. RNN æ ¸å¿ƒæ€æƒ³
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“Œ 2. RNN æ ¸å¿ƒæ€æƒ³")
print("-" * 60)

print("""
RNN æ ¸å¿ƒå…¬å¼:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚   å½“å‰è¾“å‡º = f(å½“å‰è¾“å…¥, å†å²è®°å¿†)                            â”‚
â”‚                                                              â”‚
â”‚   éšè—çŠ¶æ€:  hâ‚œ = tanh(Wâ‚“â‚• Â· xâ‚œ + Wâ‚•â‚• Â· hâ‚œâ‚‹â‚ + bâ‚•)          â”‚
â”‚   è¾“å‡º:      yâ‚œ = Wâ‚•áµ§ Â· hâ‚œ + báµ§                             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RNN å±•å¼€è§†å›¾:
    yâ‚        yâ‚‚        yâ‚ƒ        yâ‚„
    â†‘         â†‘         â†‘         â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚  hâ‚   â”‚â†’â”‚  hâ‚‚   â”‚â†’â”‚  hâ‚ƒ   â”‚â†’â”‚  hâ‚„   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘         â†‘         â†‘         â†‘
    xâ‚        xâ‚‚        xâ‚ƒ        xâ‚„
   "æˆ‘"      "çˆ±"     "åŒ—äº¬"   "å¤©å®‰é—¨"
""")

# =============================================================================
# 3. æ‰‹åŠ¨å®ç° RNN
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“Œ 3. æ‰‹åŠ¨å®ç° RNN (NumPy)")
print("-" * 60)


class SimpleRNN:
    """ä»é›¶å®ç° RNN"""

    def __init__(self, input_size, hidden_size, output_size):
        self.hidden_size = hidden_size

        # åˆå§‹åŒ–æƒé‡ (Xavier)
        scale = np.sqrt(2.0 / (input_size + hidden_size))
        self.Wxh = np.random.randn(hidden_size, input_size) * scale  # è¾“å…¥åˆ°éšè—
        self.Whh = np.random.randn(hidden_size, hidden_size) * scale  # éšè—åˆ°éšè—
        self.Why = np.random.randn(output_size, hidden_size) * scale  # éšè—åˆ°è¾“å‡º

        self.bh = np.zeros((hidden_size, 1))  # éšè—å±‚åç½®
        self.by = np.zeros((output_size, 1))  # è¾“å‡ºå±‚åç½®

    def forward(self, inputs, h_prev=None):
        """
        å‰å‘ä¼ æ’­
        Args:
            inputs: è¾“å…¥åºåˆ— [seq_len, input_size]
            h_prev: åˆå§‹éšè—çŠ¶æ€ [hidden_size, 1]
        Returns:
            outputs: è¾“å‡ºåºåˆ—
            hidden_states: æ‰€æœ‰éšè—çŠ¶æ€
        """
        seq_len = len(inputs)

        if h_prev is None:
            h_prev = np.zeros((self.hidden_size, 1))

        hidden_states = []
        outputs = []

        h = h_prev
        for t in range(seq_len):
            x = inputs[t].reshape(-1, 1)  # ç¡®ä¿æ˜¯åˆ—å‘é‡

            # æ ¸å¿ƒå…¬å¼: hâ‚œ = tanh(Wâ‚“â‚• Â· xâ‚œ + Wâ‚•â‚• Â· hâ‚œâ‚‹â‚ + bâ‚•)
            h = np.tanh(self.Wxh @ x + self.Whh @ h + self.bh)

            # è¾“å‡º: yâ‚œ = Wâ‚•áµ§ Â· hâ‚œ + báµ§
            y = self.Why @ h + self.by

            hidden_states.append(h)
            outputs.append(y)

        return outputs, hidden_states


# æµ‹è¯•æ‰‹åŠ¨å®ç°
print("\næµ‹è¯•æ‰‹åŠ¨å®ç°çš„ RNN:")
input_size = 4
hidden_size = 8
output_size = 3
seq_len = 5

rnn = SimpleRNN(input_size, hidden_size, output_size)

# åˆ›å»ºéšæœºè¾“å…¥åºåˆ—
inputs = [np.random.randn(input_size) for _ in range(seq_len)]

outputs, hidden_states = rnn.forward(inputs)

print(f"  è¾“å…¥ç»´åº¦: {input_size}")
print(f"  éšè—å±‚ç»´åº¦: {hidden_size}")
print(f"  è¾“å‡ºç»´åº¦: {output_size}")
print(f"  åºåˆ—é•¿åº¦: {seq_len}")
print(f"  è¾“å‡ºå½¢çŠ¶: {len(outputs)} Ã— {outputs[0].shape}")
print(f"  éšè—çŠ¶æ€å½¢çŠ¶: {len(hidden_states)} Ã— {hidden_states[0].shape}")


# =============================================================================
# 4. PyTorch RNN
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“Œ 4. PyTorch RNN ä½¿ç”¨")
print("-" * 60)

# PyTorch å®˜æ–¹ RNN
rnn_pytorch = nn.RNN(
    input_size=input_size,
    hidden_size=hidden_size,
    num_layers=1,
    batch_first=True,  # è¾“å…¥æ ¼å¼: [batch, seq, feature]
)

# åˆ›å»ºè¾“å…¥: [batch_size, seq_len, input_size]
batch_size = 2
x = torch.randn(batch_size, seq_len, input_size)

# åˆå§‹éšè—çŠ¶æ€: [num_layers, batch_size, hidden_size]
h0 = torch.zeros(1, batch_size, hidden_size)

# å‰å‘ä¼ æ’­
output, hn = rnn_pytorch(x, h0)

print(f"\nPyTorch RNN:")
print(f"  è¾“å…¥å½¢çŠ¶: {x.shape}")
print(f"  è¾“å‡ºå½¢çŠ¶: {output.shape}")
print(f"  æœ€ç»ˆéšè—çŠ¶æ€å½¢çŠ¶: {hn.shape}")

# æŸ¥çœ‹å‚æ•°
print(f"\nRNN å‚æ•°:")
for name, param in rnn_pytorch.named_parameters():
    print(f"  {name}: {param.shape}")


# =============================================================================
# 5. å¯è§†åŒ–éšè—çŠ¶æ€æ¼”å˜
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“Œ 5. éšè—çŠ¶æ€å¯è§†åŒ–")
print("-" * 60)

# æ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„åºåˆ—
torch.manual_seed(42)
rnn_vis = nn.RNN(input_size=1, hidden_size=16, batch_first=True)

# åˆ›å»ºæ­£å¼¦æ³¢è¾“å…¥
t = torch.linspace(0, 4 * np.pi, 50)
x_wave = torch.sin(t).unsqueeze(0).unsqueeze(-1)  # [1, 50, 1]

# å‰å‘ä¼ æ’­
with torch.no_grad():
    output, _ = rnn_vis(x_wave)
    hidden_evolution = output.squeeze(0).numpy()  # [50, 16]

# å¯è§†åŒ–
fig, axes = plt.subplots(2, 1, figsize=(12, 6))

# è¾“å…¥ä¿¡å·
axes[0].plot(t.numpy(), x_wave.squeeze().numpy(), "b-", linewidth=2)
axes[0].set_title("è¾“å…¥åºåˆ— (æ­£å¼¦æ³¢)")
axes[0].set_xlabel("æ—¶é—´æ­¥")
axes[0].set_ylabel("å€¼")
axes[0].grid(True, alpha=0.3)

# éšè—çŠ¶æ€çƒ­åŠ›å›¾
im = axes[1].imshow(hidden_evolution.T, aspect="auto", cmap="RdBu_r")
axes[1].set_title("éšè—çŠ¶æ€æ¼”å˜ (16ä¸ªç¥ç»å…ƒ)")
axes[1].set_xlabel("æ—¶é—´æ­¥")
axes[1].set_ylabel("éšè—ç¥ç»å…ƒ")
plt.colorbar(im, ax=axes[1])

plt.tight_layout()
plt.savefig("outputs/rnn_hidden_states.png", dpi=100)
plt.close()
print("éšè—çŠ¶æ€å¯è§†åŒ–å·²ä¿å­˜: outputs/rnn_hidden_states.png")


# =============================================================================
# 6. RNN çš„å±€é™æ€§
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“Œ 6. RNN çš„å±€é™æ€§")
print("-" * 60)

print("""
RNN çš„æ ¸å¿ƒé—®é¢˜ï¼šæ¢¯åº¦æ¶ˆå¤±/çˆ†ç‚¸

æ¢¯åº¦æ¶ˆå¤±ç¤ºä¾‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚  âˆ‚hâ‚„/âˆ‚hâ‚ = âˆ‚hâ‚„/âˆ‚hâ‚ƒ Â· âˆ‚hâ‚ƒ/âˆ‚hâ‚‚ Â· âˆ‚hâ‚‚/âˆ‚hâ‚                      â”‚
â”‚                                                              â”‚
â”‚  å‡è®¾æ¯æ­¥æ¢¯åº¦ä¹˜ä»¥ 0.5ï¼š                                       â”‚
â”‚    æ—¶é—´æ­¥æ•°    ç´¯ç§¯æ¢¯åº¦                                        â”‚
â”‚       1         0.5                                           â”‚
â”‚       5         0.03125                                       â”‚
â”‚      10         0.001                                         â”‚
â”‚      20         0.000001                                      â”‚
â”‚      50         â‰ˆ 0                                           â”‚
â”‚                                                              â”‚
â”‚  ç»“è®ºï¼šé•¿è·ç¦»ä¾èµ–ä¿¡æ¯æ— æ³•ä¼ é€’ï¼                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§£å†³æ–¹æ¡ˆ:
  â€¢ LSTM (Long Short-Term Memory) - æ·»åŠ é—¨æ§æœºåˆ¶
  â€¢ GRU (Gated Recurrent Unit) - ç®€åŒ–ç‰ˆ LSTM
  â€¢ æ¢¯åº¦è£å‰ª (Gradient Clipping) - é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
""")


# =============================================================================
# 7. ç»ƒä¹ 
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“ ç»ƒä¹ é¢˜")
print("-" * 60)

print("""
1. RNN çš„éšè—çŠ¶æ€ hâ‚œ åŒ…å«ä»€ä¹ˆä¿¡æ¯ï¼Ÿ
   ç­”ï¼šåŒ…å«ä» tâ‚€ åˆ° tâ‚œ çš„æ‰€æœ‰å†å²ä¿¡æ¯çš„å‹ç¼©è¡¨ç¤º

2. ä¸ºä»€ä¹ˆ RNN ä½¿ç”¨ tanh è€Œä¸æ˜¯ ReLUï¼Ÿ
   ç­”ï¼štanh è¾“å‡ºèŒƒå›´ (-1, 1)ï¼Œæœ‰åŠ©äºç¨³å®šéšè—çŠ¶æ€ï¼›
       ReLU å¯èƒ½å¯¼è‡´éšè—çŠ¶æ€æ— é™å¢é•¿

3. RNN çš„å‚æ•°æ˜¯å¦‚ä½•åœ¨æ—¶é—´æ­¥ä¹‹é—´å…±äº«çš„ï¼Ÿ
   ç­”ï¼šWâ‚“â‚•, Wâ‚•â‚•, Wâ‚•áµ§ åœ¨æ‰€æœ‰æ—¶é—´æ­¥å…±äº«åŒä¸€å¥—å‚æ•°

4. å¦‚æœåºåˆ—é•¿åº¦ä¸º 100ï¼ŒRNN ä¼šæœ‰å¤šå°‘æ¬¡çŸ©é˜µä¹˜æ³•ï¼Ÿ
   ç­”ï¼š100 æ¬¡ï¼ˆæ¯ä¸ªæ—¶é—´æ­¥ä¸€æ¬¡ï¼‰
""")

print("\nâœ… ç¬¬1èŠ‚å®Œæˆï¼")
print("ä¸‹ä¸€èŠ‚ï¼š02-bptt.py - æ—¶é—´åå‘ä¼ æ’­")
