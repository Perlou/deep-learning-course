"""
06-bidirectional.py - åŒå‘ RNN

æœ¬èŠ‚å­¦ä¹ :
1. åŒå‘ RNN çš„åŸç†
2. ä¸ºä»€ä¹ˆéœ€è¦åŒå‘
3. PyTorch åŒå‘ LSTM/GRU
4. åº”ç”¨åœºæ™¯
"""

import torch
import torch.nn as nn
import numpy as np
import matplotlib.pyplot as plt

plt.rcParams["font.sans-serif"] = ["Arial Unicode MS"]
plt.rcParams["axes.unicode_minus"] = False

print("=" * 60)
print("ç¬¬6èŠ‚: åŒå‘ RNN")
print("=" * 60)

# =============================================================================
# 1. åŒå‘ RNN åŸç†
# =============================================================================
print("""
ğŸ“š åŒå‘ RNN (Bidirectional RNN)

æ ¸å¿ƒæ€æƒ³: åŒæ—¶è€ƒè™‘è¿‡å»å’Œæœªæ¥çš„ä¸Šä¸‹æ–‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚  å•å‘ RNN:  xâ‚ â†’ xâ‚‚ â†’ xâ‚ƒ â†’ xâ‚„                               â”‚
â”‚             åªèƒ½çœ‹åˆ°è¿‡å»çš„ä¿¡æ¯                               â”‚
â”‚                                                              â”‚
â”‚  åŒå‘ RNN:                                                   â”‚
â”‚             â†’ â†’ â†’ â†’ (å‰å‘)                                   â”‚
â”‚    xâ‚   xâ‚‚   xâ‚ƒ   xâ‚„                                        â”‚
â”‚             â† â† â† â† (åå‘)                                   â”‚
â”‚                                                              â”‚
â”‚  å¯ä»¥åŒæ—¶åˆ©ç”¨è¿‡å»å’Œæœªæ¥çš„ä¿¡æ¯ï¼                              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å‡ºæ‹¼æ¥:
  hâ‚œ = [hâƒ—â‚œ ; hâƒ–â‚œ]  (å‰å‘å’Œåå‘æ‹¼æ¥)
  è¾“å‡ºç»´åº¦å˜ä¸º 2 Ã— hidden_size
""")


# =============================================================================
# 2. ä¸ºä»€ä¹ˆéœ€è¦åŒå‘
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“Œ 2. ä¸ºä»€ä¹ˆéœ€è¦åŒå‘ RNN")
print("-" * 60)

print("""
ç¤ºä¾‹ï¼šå‘½åå®ä½“è¯†åˆ« (NER)

å¥å­: "è‹¹æœå…¬å¸å‘å¸ƒäº†æ–°æ¬¾ iPhone"

å•å‘ RNN å¤„ç† "è‹¹æœ" æ—¶:
  âœ— åªçŸ¥é“ "è‹¹æœ" æ˜¯ç¬¬ä¸€ä¸ªè¯
  âœ— ä¸çŸ¥é“åé¢æœ‰ "å…¬å¸"
  âœ— å¯èƒ½è¯¯åˆ¤ä¸ºæ°´æœ

åŒå‘ RNN å¤„ç† "è‹¹æœ" æ—¶:
  âœ“ å‰å‘: çœ‹åˆ° "è‹¹æœ" æ˜¯å¥é¦–
  âœ“ åå‘: çœ‹åˆ°åé¢æœ‰ "å…¬å¸"ã€"iPhone"
  âœ“ æ­£ç¡®åˆ¤æ–­ä¸ºå…¬å¸åç§°

é€‚ç”¨åœºæ™¯:
  âœ“ æ–‡æœ¬åˆ†ç±»
  âœ“ å‘½åå®ä½“è¯†åˆ«
  âœ“ æœºå™¨ç¿»è¯‘ (ç¼–ç å™¨)
  âœ“ è¯­éŸ³è¯†åˆ«
  
ä¸é€‚ç”¨åœºæ™¯:
  âœ— è¯­è¨€æ¨¡å‹ (åªèƒ½çœ‹è¿‡å»)
  âœ— å®æ—¶æµæ•°æ®å¤„ç†
""")


# =============================================================================
# 3. PyTorch åŒå‘ RNN
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“Œ 3. PyTorch åŒå‘ LSTM/GRU")
print("-" * 60)

batch_size = 2
seq_len = 10
input_size = 16
hidden_size = 32

# åŒå‘ LSTM
bilstm = nn.LSTM(
    input_size=input_size,
    hidden_size=hidden_size,
    num_layers=2,
    batch_first=True,
    bidirectional=True,  # å…³é”®å‚æ•°
)

x = torch.randn(batch_size, seq_len, input_size)

# åˆå§‹çŠ¶æ€: num_layers * num_directions
h0 = torch.zeros(2 * 2, batch_size, hidden_size)  # 2å±‚ Ã— åŒå‘
c0 = torch.zeros(2 * 2, batch_size, hidden_size)

output, (hn, cn) = bilstm(x, (h0, c0))

print(f"åŒå‘ LSTM (2å±‚):")
print(f"  è¾“å…¥å½¢çŠ¶: {x.shape}")
print(f"  è¾“å‡ºå½¢çŠ¶: {output.shape}")
print(f"  éšè—çŠ¶æ€å½¢çŠ¶: {hn.shape}")
print(f"  æ³¨æ„: è¾“å‡ºç»´åº¦ = hidden_size Ã— 2 = {hidden_size * 2}")

# åˆ†ç¦»å‰å‘å’Œåå‘
output_forward = output[:, :, :hidden_size]
output_backward = output[:, :, hidden_size:]
print(f"\n  å‰å‘è¾“å‡º: {output_forward.shape}")
print(f"  åå‘è¾“å‡º: {output_backward.shape}")


# =============================================================================
# 4. æå–åŒå‘éšè—çŠ¶æ€
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“Œ 4. æå–åŒå‘éšè—çŠ¶æ€")
print("-" * 60)

# éšè—çŠ¶æ€çš„æ’åˆ—: [å‰å‘å±‚0, åå‘å±‚0, å‰å‘å±‚1, åå‘å±‚1, ...]
print(f"\néšè—çŠ¶æ€ hn çš„æ’åˆ— (shape: {hn.shape}):")
print("  [0]: ç¬¬1å±‚ å‰å‘")
print("  [1]: ç¬¬1å±‚ åå‘")
print("  [2]: ç¬¬2å±‚ å‰å‘")
print("  [3]: ç¬¬2å±‚ åå‘")

# è·å–æœ€åä¸€å±‚çš„åŒå‘éšè—çŠ¶æ€
forward_final = hn[-2, :, :]  # å€’æ•°ç¬¬äºŒä¸ªæ˜¯å‰å‘
backward_final = hn[-1, :, :]  # æœ€åä¸€ä¸ªæ˜¯åå‘
combined = torch.cat([forward_final, backward_final], dim=1)

print(f"\næœ€åä¸€å±‚çŠ¶æ€:")
print(f"  å‰å‘: {forward_final.shape}")
print(f"  åå‘: {backward_final.shape}")
print(f"  æ‹¼æ¥: {combined.shape}")


# =============================================================================
# 5. åŒå‘ RNN æ–‡æœ¬åˆ†ç±»å™¨
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“Œ 5. åŒå‘ RNN æ–‡æœ¬åˆ†ç±»å™¨")
print("-" * 60)


class BiLSTMClassifier(nn.Module):
    """åŒå‘ LSTM æ–‡æœ¬åˆ†ç±»å™¨"""

    def __init__(self, vocab_size, embed_dim, hidden_dim, num_classes, num_layers=2):
        super().__init__()

        self.embedding = nn.Embedding(vocab_size, embed_dim, padding_idx=0)

        self.lstm = nn.LSTM(
            embed_dim,
            hidden_dim,
            num_layers=num_layers,
            batch_first=True,
            bidirectional=True,
            dropout=0.3,
        )

        # æ³¨æ„: hidden_dim * 2 å› ä¸ºåŒå‘
        self.fc = nn.Linear(hidden_dim * 2, num_classes)
        self.dropout = nn.Dropout(0.5)

    def forward(self, x):
        # x: [batch, seq_len]
        embedded = self.embedding(x)

        lstm_out, (hn, cn) = self.lstm(embedded)

        # æ–¹æ³•1: ä½¿ç”¨æœ€åä¸€å±‚åŒå‘éšè—çŠ¶æ€
        forward_h = hn[-2]
        backward_h = hn[-1]
        hidden = torch.cat([forward_h, backward_h], dim=1)

        # æ–¹æ³•2 (å¯é€‰): ä½¿ç”¨å¹³å‡æ± åŒ–
        # hidden = lstm_out.mean(dim=1)

        hidden = self.dropout(hidden)
        output = self.fc(hidden)

        return output


# æµ‹è¯•æ¨¡å‹
model = BiLSTMClassifier(vocab_size=10000, embed_dim=128, hidden_dim=256, num_classes=5)

x = torch.randint(0, 10000, (4, 50))  # 4ä¸ªæ ·æœ¬ï¼Œé•¿åº¦50
output = model(x)

print(f"\nåŒå‘ LSTM æ–‡æœ¬åˆ†ç±»å™¨:")
print(f"  è¾“å…¥: {x.shape}")
print(f"  è¾“å‡º: {output.shape}")
print(f"  å‚æ•°é‡: {sum(p.numel() for p in model.parameters()):,}")


# =============================================================================
# 6. å•å‘ vs åŒå‘å¯¹æ¯”
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“Œ 6. å•å‘ vs åŒå‘å¯¹æ¯”")
print("-" * 60)

# åˆ›å»ºä¸¤ä¸ªæ¨¡å‹
lstm_uni = nn.LSTM(16, 32, batch_first=True, bidirectional=False)
lstm_bi = nn.LSTM(16, 32, batch_first=True, bidirectional=True)

print("å‚æ•°é‡å¯¹æ¯”:")
print(f"  å•å‘ LSTM: {sum(p.numel() for p in lstm_uni.parameters()):,}")
print(f"  åŒå‘ LSTM: {sum(p.numel() for p in lstm_bi.parameters()):,}")
print(
    f"  æ¯”ç‡: åŒå‘/å•å‘ = {sum(p.numel() for p in lstm_bi.parameters()) / sum(p.numel() for p in lstm_uni.parameters()):.1f}x"
)

print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‰¹æ€§              â”‚  å•å‘ RNN          â”‚  åŒå‘ RNN          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸Šä¸‹æ–‡ä¿¡æ¯        â”‚  åªæœ‰è¿‡å»          â”‚  è¿‡å» + æœªæ¥        â”‚
â”‚  è¾“å‡ºç»´åº¦          â”‚  hidden_size       â”‚  hidden_size Ã— 2    â”‚
â”‚  å‚æ•°é‡            â”‚  1x                â”‚  2x                 â”‚
â”‚  è®¡ç®—æ—¶é—´          â”‚  è¾ƒå¿«              â”‚  çº¦ 2x              â”‚
â”‚  èƒ½å¦å®æ—¶          â”‚  âœ“                 â”‚  âœ— (éœ€è¦å®Œæ•´åºåˆ—)   â”‚
â”‚  é€‚ç”¨ä»»åŠ¡          â”‚  è¯­è¨€å»ºæ¨¡ã€ç”Ÿæˆ    â”‚  åˆ†ç±»ã€NERã€ç¿»è¯‘    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
""")


# =============================================================================
# 7. ç»ƒä¹ 
# =============================================================================
print("\n" + "=" * 60)
print("ğŸ“ ç»ƒä¹ é¢˜")
print("-" * 60)

print("""
1. åŒå‘ RNN çš„è¾“å‡ºç»´åº¦æ˜¯å•å‘çš„å¤šå°‘å€ï¼Ÿ
   ç­”ï¼š2 å€ (å‰å‘ + åå‘æ‹¼æ¥)

2. åŒå‘ RNN èƒ½å¦ç”¨äºè¯­è¨€æ¨¡å‹ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
   ç­”ï¼šä¸èƒ½ï¼Œå› ä¸ºè¯­è¨€æ¨¡å‹ç”Ÿæˆæ—¶çœ‹ä¸åˆ°æœªæ¥çš„è¯

3. å¦‚ä½•è·å–åŒå‘ LSTM æœ€åæ—¶åˆ»çš„å®Œæ•´è¡¨ç¤ºï¼Ÿ
   ç­”ï¼šæ‹¼æ¥å‰å‘æœ€åæ—¶åˆ»å’Œåå‘ç¬¬ä¸€æ—¶åˆ»çš„éšè—çŠ¶æ€

4. åœ¨ PyTorch ä¸­ï¼Œnum_layers=2, bidirectional=True æ—¶ï¼Œ
   éšè—çŠ¶æ€ hn çš„ç¬¬ä¸€ç»´å¤§å°æ˜¯å¤šå°‘ï¼Ÿ
   ç­”ï¼š4 (2å±‚ Ã— 2æ–¹å‘)
""")

print("\nâœ… ç¬¬6èŠ‚å®Œæˆï¼")
print("ä¸‹ä¸€èŠ‚ï¼š07-seq2seq.py - åºåˆ—åˆ°åºåˆ—æ¨¡å‹")
