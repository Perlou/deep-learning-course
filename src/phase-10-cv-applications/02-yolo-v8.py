"""
YOLO ç³»åˆ—æ£€æµ‹å™¨ (YOLO Family)
==============================

å­¦ä¹ ç›®æ ‡ï¼š
    1. ç†è§£ YOLO çš„æ ¸å¿ƒæ€æƒ³å’Œå·¥ä½œåŸç†
    2. äº†è§£ YOLO ç‰ˆæœ¬æ¼”è¿› (v1 åˆ° v8)
    3. æŒæ¡ YOLOv8 çš„ä½¿ç”¨æ–¹æ³•
    4. å­¦ä¼šåœ¨è‡ªå®šä¹‰æ•°æ®é›†ä¸Šè®­ç»ƒ YOLO

æ ¸å¿ƒæ¦‚å¿µï¼š
    - å•é˜¶æ®µæ£€æµ‹: ä¸€æ¬¡å‰å‘ä¼ æ’­å®Œæˆæ£€æµ‹
    - ç½‘æ ¼é¢„æµ‹: å°†å›¾åƒåˆ’åˆ†ä¸ºç½‘æ ¼
    - å¤šå°ºåº¦æ£€æµ‹: æ£€æµ‹ä¸åŒå¤§å°çš„ç‰©ä½“
    - Anchor-Free: YOLOv8 ä¸ä½¿ç”¨é¢„å®šä¹‰ Anchor

å‰ç½®çŸ¥è¯†ï¼š
    - 01-detection-basics.py: ç›®æ ‡æ£€æµ‹åŸºç¡€
"""

import torch
import torch.nn as nn
import numpy as np

# æ³¨æ„: è¿è¡Œ YOLOv8 ç¤ºä¾‹éœ€è¦å®‰è£… ultralytics
# pip install ultralytics


# ==================== ç¬¬ä¸€éƒ¨åˆ†ï¼šYOLO æ ¸å¿ƒæ€æƒ³ ====================


def introduction():
    """YOLO æ ¸å¿ƒæ€æƒ³"""
    print("=" * 60)
    print("ç¬¬ä¸€éƒ¨åˆ†ï¼šYOLO æ ¸å¿ƒæ€æƒ³")
    print("=" * 60)

    print("""
YOLO (You Only Look Once)ï¼š

    æ ¸å¿ƒç†å¿µ: ä¸€æ¬¡å‰å‘ä¼ æ’­å®Œæˆç›®æ ‡æ£€æµ‹

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ä¼ ç»Ÿæ–¹æ³• (R-CNN ç³»åˆ—):                                  â”‚
    â”‚  å›¾åƒ â†’ å€™é€‰åŒºåŸŸ â†’ é€ä¸ªåˆ†ç±» â†’ NMS â†’ ç»“æœ                  â”‚
    â”‚         (2000ä¸ª)    (æ…¢!)                               â”‚
    â”‚                                                         â”‚
    â”‚  YOLO:                                                  â”‚
    â”‚  å›¾åƒ â†’ CNN â†’ ç›´æ¥è¾“å‡ºæ‰€æœ‰æ£€æµ‹ç»“æœ â†’ NMS â†’ ç»“æœ           â”‚
    â”‚              (ä¸€æ¬¡!)                                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

YOLO å·¥ä½œåŸç†ï¼š

    1. å°†å›¾åƒåˆ’åˆ†ä¸º SÃ—S ç½‘æ ¼ (å¦‚ 7Ã—7)
    2. æ¯ä¸ªç½‘æ ¼è´Ÿè´£æ£€æµ‹ä¸­å¿ƒè½åœ¨è¯¥ç½‘æ ¼çš„ç‰©ä½“
    3. æ¯ä¸ªç½‘æ ¼é¢„æµ‹ B ä¸ªè¾¹ç•Œæ¡†å’Œ C ä¸ªç±»åˆ«æ¦‚ç‡

    â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
    â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚
    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤
    â”‚   â”‚   â”‚ ğŸ±â”‚   â”‚   â”‚   â”‚   â”‚ â† çŒ«çš„ä¸­å¿ƒåœ¨æ­¤ç½‘æ ¼
    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤     è¯¥ç½‘æ ¼è´Ÿè´£é¢„æµ‹çŒ«
    â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚
    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤
    â”‚   â”‚   â”‚   â”‚   â”‚ ğŸ•â”‚   â”‚   â”‚ â† ç‹—çš„ä¸­å¿ƒåœ¨æ­¤ç½‘æ ¼
    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤
    â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚
    â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜

è¾“å‡ºå¼ é‡å½¢çŠ¶ï¼š
    S Ã— S Ã— (B Ã— 5 + C)

    å…¶ä¸­:
    - S: ç½‘æ ¼å¤§å°
    - B: æ¯ä¸ªç½‘æ ¼çš„è¾¹ç•Œæ¡†æ•°
    - 5: (x, y, w, h, confidence)
    - C: ç±»åˆ«æ•°
    """)


# ==================== ç¬¬äºŒéƒ¨åˆ†ï¼šYOLO ç‰ˆæœ¬æ¼”è¿› ====================


def yolo_evolution():
    """YOLO ç‰ˆæœ¬æ¼”è¿›"""
    print("\n" + "=" * 60)
    print("ç¬¬äºŒéƒ¨åˆ†ï¼šYOLO ç‰ˆæœ¬æ¼”è¿›")
    print("=" * 60)

    print("""
YOLO å‘å±•å†ç¨‹ï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç‰ˆæœ¬    å¹´ä»½   å…³é”®æ”¹è¿›                    é€Ÿåº¦    ç²¾åº¦   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ v1      2016   å¼€åˆ›æ€§å·¥ä½œ                  â˜…â˜…â˜…â˜…   â˜…â˜…    â”‚
    â”‚ v2      2017   Batch Norm, Anchor         â˜…â˜…â˜…â˜…â˜…  â˜…â˜…â˜…   â”‚
    â”‚ v3      2018   å¤šå°ºåº¦é¢„æµ‹, Darknet-53      â˜…â˜…â˜…â˜…   â˜…â˜…â˜…â˜…  â”‚
    â”‚ v4      2020   CSP, PANet, Mosaic         â˜…â˜…â˜…â˜…   â˜…â˜…â˜…â˜…â˜… â”‚
    â”‚ v5      2020   PyTorch, æ˜“ç”¨æ€§            â˜…â˜…â˜…â˜…   â˜…â˜…â˜…â˜…  â”‚
    â”‚ v6      2022   RepVGG backbone            â˜…â˜…â˜…â˜…â˜…  â˜…â˜…â˜…â˜…  â”‚
    â”‚ v7      2022   E-ELAN, è®­ç»ƒæŠ€å·§           â˜…â˜…â˜…â˜…   â˜…â˜…â˜…â˜…â˜… â”‚
    â”‚ v8      2023   Anchor-Free, ç»Ÿä¸€æ¡†æ¶       â˜…â˜…â˜…â˜…â˜…  â˜…â˜…â˜…â˜…â˜… â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®æŠ€æœ¯æ¼”è¿›ï¼š

    YOLOv1 â†’ v2:
    â”œâ”€â”€ Batch Normalization
    â”œâ”€â”€ é«˜åˆ†è¾¨ç‡åˆ†ç±»å™¨é¢„è®­ç»ƒ
    â”œâ”€â”€ Anchor Boxes
    â””â”€â”€ ç›´æ¥ä½ç½®é¢„æµ‹

    YOLOv3:
    â”œâ”€â”€ å¤šå°ºåº¦é¢„æµ‹ (3ä¸ªå°ºåº¦)
    â”œâ”€â”€ æ›´å¥½çš„ Backbone (Darknet-53)
    â””â”€â”€ ç‹¬ç«‹çš„åˆ†ç±»å™¨ (å¤šæ ‡ç­¾åˆ†ç±»)

    YOLOv4/v5:
    â”œâ”€â”€ CSPNet: è·¨é˜¶æ®µå±€éƒ¨ç½‘ç»œ
    â”œâ”€â”€ PANet: è·¯å¾„èšåˆç½‘ç»œ
    â”œâ”€â”€ Mosaic æ•°æ®å¢å¼º
    â””â”€â”€ è‡ªå¯¹æŠ—è®­ç»ƒ

    YOLOv8:
    â”œâ”€â”€ Anchor-Free è®¾è®¡
    â”œâ”€â”€ è§£è€¦å¤´ (Decoupled Head)
    â”œâ”€â”€ ç»Ÿä¸€çš„è®­ç»ƒ/æ¨ç†æ¡†æ¶
    â””â”€â”€ æ”¯æŒæ£€æµ‹ã€åˆ†å‰²ã€å§¿æ€ä¼°è®¡
    """)


# ==================== ç¬¬ä¸‰éƒ¨åˆ†ï¼šYOLOv8 æ¶æ„ ====================


def yolov8_architecture():
    """YOLOv8 æ¶æ„"""
    print("\n" + "=" * 60)
    print("ç¬¬ä¸‰éƒ¨åˆ†ï¼šYOLOv8 æ¶æ„")
    print("=" * 60)

    print("""
YOLOv8 æ¶æ„æ¦‚è§ˆï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     YOLOv8 æ¶æ„                          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                         â”‚
    â”‚  Input (640Ã—640)                                        â”‚
    â”‚       â†“                                                 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚              Backbone (CSPDarknet)              â”‚    â”‚
    â”‚  â”‚  Conv â†’ C2f â†’ Conv â†’ C2f â†’ Conv â†’ C2f â†’ SPPF   â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚       â†“                                                 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚                  Neck (PAN-FPN)                 â”‚    â”‚
    â”‚  â”‚  ç‰¹å¾é‡‘å­—å¡” + è·¯å¾„èšåˆï¼Œèåˆå¤šå°ºåº¦ç‰¹å¾             â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚       â†“                                                 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚              Head (Decoupled Head)              â”‚    â”‚
    â”‚  â”‚  åˆ†ç±»åˆ†æ”¯ + å›å½’åˆ†æ”¯ (è§£è€¦è®¾è®¡)                   â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚       â†“                                                 â”‚
    â”‚  è¾“å‡º: è¾¹ç•Œæ¡† + ç±»åˆ« + ç½®ä¿¡åº¦                           â”‚
    â”‚                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

YOLOv8 æ¨¡å‹å˜ä½“ï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ¨¡å‹      å‚æ•°é‡     é€Ÿåº¦(FPS)    mAP@0.5:0.95          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  YOLOv8n   3.2M       ~200         37.3%                â”‚
    â”‚  YOLOv8s   11.2M      ~150         44.9%                â”‚
    â”‚  YOLOv8m   25.9M      ~100         50.2%                â”‚
    â”‚  YOLOv8l   43.7M      ~70          52.9%                â”‚
    â”‚  YOLOv8x   68.2M      ~50          53.9%                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    n=nano, s=small, m=medium, l=large, x=xlarge
    """)


# ==================== ç¬¬å››éƒ¨åˆ†ï¼šYOLOv8 ä½¿ç”¨ ====================


def yolov8_usage():
    """YOLOv8 ä½¿ç”¨"""
    print("\n" + "=" * 60)
    print("ç¬¬å››éƒ¨åˆ†ï¼šYOLOv8 ä½¿ç”¨")
    print("=" * 60)

    print("""
å®‰è£… YOLOv8ï¼š
    pip install ultralytics

åŸºæœ¬ä½¿ç”¨ï¼š
    """)

    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† ultralytics
    try:
        from ultralytics import YOLO

        print("âœ“ ultralytics å·²å®‰è£…\n")

        # åŠ è½½é¢„è®­ç»ƒæ¨¡å‹
        print("ç¤ºä¾‹1: åŠ è½½é¢„è®­ç»ƒæ¨¡å‹\n")
        print(">>> from ultralytics import YOLO")
        print(">>> model = YOLO('yolov8n.pt')  # åŠ è½½ nano ç‰ˆæœ¬")

        # æ¨¡å‹æ¨ç†ç¤ºä¾‹
        print("\nç¤ºä¾‹2: å›¾åƒæ£€æµ‹\n")
        print("""
>>> results = model('image.jpg')
>>> 
>>> for result in results:
>>>     boxes = result.boxes
>>>     for box in boxes:
>>>         cls = int(box.cls[0])          # ç±»åˆ«ç´¢å¼•
>>>         conf = float(box.conf[0])       # ç½®ä¿¡åº¦
>>>         xyxy = box.xyxy[0].tolist()     # è¾¹ç•Œæ¡†åæ ‡
>>>         name = model.names[cls]         # ç±»åˆ«åç§°
>>>         print(f'{name}: {conf:.2f}, {xyxy}')
        """)

        # è§†é¢‘æ£€æµ‹
        print("ç¤ºä¾‹3: è§†é¢‘æ£€æµ‹\n")
        print("""
>>> results = model('video.mp4', stream=True)
>>> for result in results:
>>>     # å¤„ç†æ¯ä¸€å¸§
>>>     pass
        """)

        # ä½¿ç”¨ GPU
        print("ç¤ºä¾‹4: ä½¿ç”¨ GPU\n")
        print("""
>>> model = YOLO('yolov8n.pt')
>>> results = model('image.jpg', device='cuda')
        """)

    except ImportError:
        print("âš  ultralytics æœªå®‰è£…")
        print("è¯·è¿è¡Œ: pip install ultralytics")

    print("""
å‘½ä»¤è¡Œä½¿ç”¨ï¼š

    # æ£€æµ‹
    yolo detect predict model=yolov8n.pt source=image.jpg

    # è®­ç»ƒ
    yolo detect train data=coco.yaml model=yolov8n.pt epochs=100

    # éªŒè¯
    yolo detect val model=yolov8n.pt data=coco.yaml
    """)


# ==================== ç¬¬äº”éƒ¨åˆ†ï¼šè‡ªå®šä¹‰è®­ç»ƒ ====================


def custom_training():
    """è‡ªå®šä¹‰è®­ç»ƒ"""
    print("\n" + "=" * 60)
    print("ç¬¬äº”éƒ¨åˆ†ï¼šè‡ªå®šä¹‰æ•°æ®é›†è®­ç»ƒ")
    print("=" * 60)

    print("""
æ•°æ®é›†æ ¼å¼ (YOLO æ ¼å¼)ï¼š

    dataset/
    â”œâ”€â”€ images/
    â”‚   â”œâ”€â”€ train/
    â”‚   â”‚   â”œâ”€â”€ img001.jpg
    â”‚   â”‚   â””â”€â”€ img002.jpg
    â”‚   â””â”€â”€ val/
    â”‚       â”œâ”€â”€ img003.jpg
    â”‚       â””â”€â”€ img004.jpg
    â”œâ”€â”€ labels/
    â”‚   â”œâ”€â”€ train/
    â”‚   â”‚   â”œâ”€â”€ img001.txt
    â”‚   â”‚   â””â”€â”€ img002.txt
    â”‚   â””â”€â”€ val/
    â”‚       â”œâ”€â”€ img003.txt
    â”‚       â””â”€â”€ img004.txt
    â””â”€â”€ dataset.yaml

æ ‡æ³¨æ ¼å¼ (æ¯è¡Œä¸€ä¸ªç‰©ä½“):
    <class_id> <x_center> <y_center> <width> <height>

    æ‰€æœ‰å€¼éƒ½æ˜¯å½’ä¸€åŒ–çš„ (0-1)
    ä¾‹å¦‚: 0 0.5 0.5 0.2 0.3

dataset.yaml é…ç½®:
    """)

    print("""
# dataset.yaml
path: /path/to/dataset
train: images/train
val: images/val

names:
  0: person
  1: car
  2: dog
  3: cat
    """)

    print("""
è®­ç»ƒä»£ç ï¼š

>>> from ultralytics import YOLO
>>> 
>>> # åŠ è½½é¢„è®­ç»ƒæ¨¡å‹
>>> model = YOLO('yolov8n.pt')
>>> 
>>> # è®­ç»ƒ
>>> results = model.train(
>>>     data='dataset.yaml',
>>>     epochs=100,
>>>     imgsz=640,
>>>     batch=16,
>>>     device='cuda',
>>>     workers=4,
>>>     patience=50,        # æ—©åœ
>>>     save=True,          # ä¿å­˜æ¨¡å‹
>>>     project='runs/detect',
>>>     name='custom_train'
>>> )
>>> 
>>> # éªŒè¯
>>> metrics = model.val()
>>> print(f'mAP50: {metrics.box.map50}')
>>> print(f'mAP50-95: {metrics.box.map}')
>>> 
>>> # å¯¼å‡ºæ¨¡å‹
>>> model.export(format='onnx')  # å¯¼å‡ºä¸º ONNX
    """)


# ==================== ç¬¬å…­éƒ¨åˆ†ï¼šYOLO æ ¸å¿ƒä»£ç è§£æ ====================


def yolo_core_code():
    """YOLO æ ¸å¿ƒä»£ç è§£æ"""
    print("\n" + "=" * 60)
    print("ç¬¬å…­éƒ¨åˆ†ï¼šYOLO æ ¸å¿ƒä»£ç è§£æ")
    print("=" * 60)

    print("ç¤ºä¾‹1: C2f æ¨¡å— (YOLOv8 æ ¸å¿ƒæ¨¡å—)\n")

    class C2f(nn.Module):
        """CSP Bottleneck with 2 convolutions"""

        def __init__(self, c1, c2, n=1, shortcut=True):
            super().__init__()
            self.c = int(c2 * 0.5)  # éšè—é€šé“æ•°
            self.cv1 = nn.Conv2d(c1, 2 * self.c, 1, 1)
            self.cv2 = nn.Conv2d((2 + n) * self.c, c2, 1, 1)
            self.m = nn.ModuleList(
                [Bottleneck(self.c, self.c, shortcut) for _ in range(n)]
            )

        def forward(self, x):
            # åˆ†å‰² + å †å 
            y = list(self.cv1(x).chunk(2, 1))
            y.extend(m(y[-1]) for m in self.m)
            return self.cv2(torch.cat(y, 1))

    class Bottleneck(nn.Module):
        """æ ‡å‡† Bottleneck"""

        def __init__(self, c1, c2, shortcut=True):
            super().__init__()
            self.cv1 = nn.Conv2d(c1, c2, 3, 1, 1)
            self.cv2 = nn.Conv2d(c2, c2, 3, 1, 1)
            self.add = shortcut and c1 == c2

        def forward(self, x):
            return x + self.cv2(self.cv1(x)) if self.add else self.cv2(self.cv1(x))

    print("C2f æ¨¡å—ç»“æ„:")
    print("  è¾“å…¥ â†’ Conv1 â†’ åˆ†å‰² â†’ [Bottleneck Ã— n] â†’ æ‹¼æ¥ â†’ Conv2 â†’ è¾“å‡º")

    print("\nç¤ºä¾‹2: æ£€æµ‹å¤´ (Decoupled Head)\n")

    class DetectHead(nn.Module):
        """YOLOv8 æ£€æµ‹å¤´ (è§£è€¦è®¾è®¡)"""

        def __init__(self, nc=80, ch=(256, 512, 1024)):
            super().__init__()
            self.nc = nc  # ç±»åˆ«æ•°
            self.reg_max = 16  # DFL ä½¿ç”¨

            # åˆ†ç±»åˆ†æ”¯
            self.cls_convs = nn.ModuleList()
            self.cls_preds = nn.ModuleList()

            # å›å½’åˆ†æ”¯
            self.reg_convs = nn.ModuleList()
            self.reg_preds = nn.ModuleList()

            for c in ch:
                self.cls_convs.append(
                    nn.Sequential(
                        nn.Conv2d(c, c, 3, 1, 1), nn.BatchNorm2d(c), nn.SiLU()
                    )
                )
                self.cls_preds.append(nn.Conv2d(c, nc, 1))

                self.reg_convs.append(
                    nn.Sequential(
                        nn.Conv2d(c, c, 3, 1, 1), nn.BatchNorm2d(c), nn.SiLU()
                    )
                )
                self.reg_preds.append(nn.Conv2d(c, 4 * self.reg_max, 1))

        def forward(self, x):
            outputs = []
            for i, f in enumerate(x):
                cls_feat = self.cls_convs[i](f)
                reg_feat = self.reg_convs[i](f)

                cls_pred = self.cls_preds[i](cls_feat)
                reg_pred = self.reg_preds[i](reg_feat)

                outputs.append((cls_pred, reg_pred))
            return outputs

    print("è§£è€¦å¤´ç‰¹ç‚¹:")
    print("  - åˆ†ç±»å’Œå›å½’ä½¿ç”¨ç‹¬ç«‹çš„åˆ†æ”¯")
    print("  - æ›´å¥½çš„ä»»åŠ¡ä¸“æ³¨æ€§")
    print("  - æå‡æ£€æµ‹ç²¾åº¦")


# ==================== ç¬¬ä¸ƒéƒ¨åˆ†ï¼šç»ƒä¹ ä¸æ€è€ƒ ====================


def exercises():
    """ç»ƒä¹ é¢˜"""
    print("\n" + "=" * 60)
    print("ç»ƒä¹ ä¸æ€è€ƒ")
    print("=" * 60)

    print("""
ç»ƒä¹  1ï¼šä½¿ç”¨ YOLOv8 æ£€æµ‹å›¾åƒ
    ä»»åŠ¡: ä¸‹è½½ä¸€å¼ å›¾ç‰‡ï¼Œä½¿ç”¨ YOLOv8n è¿›è¡Œæ£€æµ‹
    è¦æ±‚: æ‰“å°æ‰€æœ‰æ£€æµ‹ç»“æœï¼Œå¹¶ä¿å­˜æ ‡æ³¨åçš„å›¾åƒ

ç»ƒä¹  2ï¼šè‡ªå®šä¹‰æ•°æ®é›†è®­ç»ƒ
    ä»»åŠ¡: æ”¶é›† 50 å¼ å›¾ç‰‡ï¼Œæ ‡æ³¨ä¸€ç§ç‰©ä½“
    æç¤º: å¯ä»¥ä½¿ç”¨ labelimg æˆ– Roboflow è¿›è¡Œæ ‡æ³¨
    è¦æ±‚: è®­ç»ƒæ¨¡å‹å¹¶è¯„ä¼° mAP

ç»ƒä¹  3ï¼šæ¨¡å‹å¯¹æ¯”
    ä»»åŠ¡: å¯¹æ¯” YOLOv8n å’Œ YOLOv8s çš„æ€§èƒ½
    æ¯”è¾ƒ: æ¨ç†é€Ÿåº¦ã€mAPã€æ¨¡å‹å¤§å°

ç»ƒä¹  4ï¼šè§†é¢‘å®æ—¶æ£€æµ‹
    ä»»åŠ¡: å®ç°æ‘„åƒå¤´å®æ—¶ç›®æ ‡æ£€æµ‹
    è¦æ±‚: æ˜¾ç¤º FPSï¼Œæ”¯æŒ ESC é€€å‡º

ç»ƒä¹  5ï¼šæ¨¡å‹å¯¼å‡º
    ä»»åŠ¡: å°†è®­ç»ƒå¥½çš„æ¨¡å‹å¯¼å‡ºä¸º ONNX æˆ– TensorRT
    æµ‹è¯•å¯¼å‡ºæ¨¡å‹çš„æ¨ç†é€Ÿåº¦

æ€è€ƒé¢˜ 1ï¼šä¸ºä»€ä¹ˆ YOLOv8 é‡‡ç”¨ Anchor-Free è®¾è®¡ï¼Ÿ
    ç›¸æ¯” Anchor-Based æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

æ€è€ƒé¢˜ 2ï¼šå¤šå°ºåº¦æ£€æµ‹å¦‚ä½•å·¥ä½œï¼Ÿ
    FPN å’Œ PAN å„è‡ªçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

æ€è€ƒé¢˜ 3ï¼šå¦‚ä½•å¤„ç†å°ç›®æ ‡æ£€æµ‹é—®é¢˜ï¼Ÿ
    YOLO ç³»åˆ—æœ‰å“ªäº›é’ˆå¯¹æ€§çš„ä¼˜åŒ–ï¼Ÿ
    """)


# ==================== ä¸»å‡½æ•° ====================


def main():
    """ä¸»å‡½æ•°"""
    introduction()
    yolo_evolution()
    yolov8_architecture()
    yolov8_usage()
    custom_training()
    yolo_core_code()
    exercises()

    print("\n" + "=" * 60)
    print("è¯¾ç¨‹å®Œæˆï¼")
    print("=" * 60)
    print("""
ä¸‹ä¸€æ­¥å­¦ä¹ ï¼š
    - 03-rcnn-family.py: R-CNN ç³»åˆ—æ£€æµ‹å™¨

å…³é”®è¦ç‚¹å›é¡¾ï¼š
    âœ“ YOLO ä¸€æ¬¡å‰å‘ä¼ æ’­å®Œæˆæ£€æµ‹
    âœ“ ç½‘æ ¼åˆ’åˆ†ï¼Œæ¯ä¸ªç½‘æ ¼è´Ÿè´£é¢„æµ‹ä¸­å¿ƒè½åœ¨å…¶ä¸­çš„ç‰©ä½“
    âœ“ YOLOv8 é‡‡ç”¨ Anchor-Free è®¾è®¡
    âœ“ ä½¿ç”¨ ultralytics åº“å¯ä»¥å¿«é€Ÿä½¿ç”¨å’Œè®­ç»ƒ YOLO
    âœ“ æ”¯æŒæ£€æµ‹ã€åˆ†å‰²ã€å§¿æ€ä¼°è®¡ç­‰å¤šç§ä»»åŠ¡
    """)


if __name__ == "__main__":
    main()
