"""
ç›®æ ‡æ£€æµ‹åŸºç¡€ (Object Detection Basics)
=======================================

å­¦ä¹ ç›®æ ‡ï¼š
    1. ç†è§£ç›®æ ‡æ£€æµ‹ä»»åŠ¡çš„å®šä¹‰å’Œåº”ç”¨
    2. æŒæ¡è¾¹ç•Œæ¡†ã€IoUã€NMSç­‰æ ¸å¿ƒæ¦‚å¿µ
    3. äº†è§£ç›®æ ‡æ£€æµ‹çš„è¯„ä¼°æŒ‡æ ‡
    4. å¯¹æ¯”å•é˜¶æ®µå’Œä¸¤é˜¶æ®µæ£€æµ‹å™¨

æ ¸å¿ƒæ¦‚å¿µï¼š
    - è¾¹ç•Œæ¡† (Bounding Box): ç”¨çŸ©å½¢æ¡†å®šä½ç‰©ä½“
    - IoU (Intersection over Union): è¡¡é‡é¢„æµ‹æ¡†å’ŒçœŸå®æ¡†çš„é‡å ç¨‹åº¦
    - NMS (Non-Maximum Suppression): å»é™¤å†—ä½™æ£€æµ‹æ¡†
    - Anchor: é¢„å®šä¹‰çš„å…ˆéªŒæ¡†

å‰ç½®çŸ¥è¯†ï¼š
    - Phase 5: CNN å·ç§¯ç¥ç»ç½‘ç»œ
    - Phase 9: è®­ç»ƒæŠ€å·§ä¸ä¼˜åŒ–
"""

import torch
import torch.nn as nn
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.patches as patches


# ==================== ç¬¬ä¸€éƒ¨åˆ†ï¼šç›®æ ‡æ£€æµ‹æ¦‚è¿° ====================


def introduction():
    """ç›®æ ‡æ£€æµ‹æ¦‚è¿°"""
    print("=" * 60)
    print("ç¬¬ä¸€éƒ¨åˆ†ï¼šç›®æ ‡æ£€æµ‹æ¦‚è¿°")
    print("=" * 60)

    print("""
ç›®æ ‡æ£€æµ‹ (Object Detection)ï¼š

    ç›®æ ‡æ£€æµ‹ = åˆ†ç±» + å®šä½

    è¾“å…¥: ä¸€å¼ å›¾åƒ
    è¾“å‡º: ç‰©ä½“çš„ç±»åˆ« + ä½ç½® (è¾¹ç•Œæ¡†)

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  è¾“å…¥å›¾åƒ                   â”‚
    â”‚    ğŸ±        ğŸ•            â”‚
    â”‚                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ£€æµ‹ç»“æœ                   â”‚
    â”‚  â”Œâ”€â”€â”€â”      â”Œâ”€â”€â”€â”         â”‚
    â”‚  â”‚ğŸ± â”‚      â”‚ğŸ• â”‚         â”‚
    â”‚  â”‚catâ”‚      â”‚dogâ”‚         â”‚
    â”‚  â”‚95%â”‚      â”‚92%â”‚         â”‚
    â”‚  â””â”€â”€â”€â”˜      â””â”€â”€â”€â”˜         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®æ ‡æ£€æµ‹çš„åº”ç”¨ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. è‡ªåŠ¨é©¾é©¶: è½¦è¾†ã€è¡Œäººã€äº¤é€šæ ‡å¿—æ£€æµ‹                      â”‚
    â”‚ 2. å®‰é˜²ç›‘æ§: äººè„¸æ£€æµ‹ã€å¼‚å¸¸è¡Œä¸ºæ£€æµ‹                        â”‚
    â”‚ 3. åŒ»å­¦å½±åƒ: ç—…å˜åŒºåŸŸæ£€æµ‹                                 â”‚
    â”‚ 4. å·¥ä¸šè´¨æ£€: ç¼ºé™·æ£€æµ‹                                    â”‚
    â”‚ 5. é›¶å”®: å•†å“è¯†åˆ«ã€åº“å­˜ç®¡ç†                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ£€æµ‹å™¨åˆ†ç±»ï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ä¸¤é˜¶æ®µæ£€æµ‹å™¨ (Two-Stage)                                â”‚
    â”‚  â”œâ”€â”€ R-CNN, Fast R-CNN, Faster R-CNN                    â”‚
    â”‚  â”œâ”€â”€ å…ˆç”Ÿæˆå€™é€‰åŒºåŸŸï¼Œå†åˆ†ç±»                               â”‚
    â”‚  â””â”€â”€ ç‰¹ç‚¹: ç²¾åº¦é«˜ï¼Œé€Ÿåº¦è¾ƒæ…¢                               â”‚
    â”‚                                                         â”‚
    â”‚  å•é˜¶æ®µæ£€æµ‹å™¨ (One-Stage)                                â”‚
    â”‚  â”œâ”€â”€ YOLO, SSD, RetinaNet                               â”‚
    â”‚  â”œâ”€â”€ ç›´æ¥é¢„æµ‹ç±»åˆ«å’Œä½ç½®                                   â”‚
    â”‚  â””â”€â”€ ç‰¹ç‚¹: é€Ÿåº¦å¿«ï¼Œé€‚åˆå®æ—¶æ£€æµ‹                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)


# ==================== ç¬¬äºŒéƒ¨åˆ†ï¼šè¾¹ç•Œæ¡†åŸºç¡€ ====================


def bounding_box_basics():
    """è¾¹ç•Œæ¡†åŸºç¡€"""
    print("\n" + "=" * 60)
    print("ç¬¬äºŒéƒ¨åˆ†ï¼šè¾¹ç•Œæ¡†åŸºç¡€")
    print("=" * 60)

    print("""
è¾¹ç•Œæ¡†è¡¨ç¤ºæ–¹æ³•ï¼š

    æ–¹æ³•1: (x1, y1, x2, y2) - å·¦ä¸Šè§’å’Œå³ä¸‹è§’åæ ‡
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ (x1, y1)           â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚    â”‚   ç‰©ä½“   â”‚    â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚            (x2, y2)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    æ–¹æ³•2: (cx, cy, w, h) - ä¸­å¿ƒç‚¹åæ ‡å’Œå®½é«˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚    â”‚   (cx,cy)â”‚â†wâ†’ â”‚
    â”‚    â”‚     â—    â”‚â†‘hâ†“ â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)

    # è¾¹ç•Œæ¡†è½¬æ¢å‡½æ•°
    def xyxy_to_cxcywh(box):
        """(x1, y1, x2, y2) -> (cx, cy, w, h)"""
        x1, y1, x2, y2 = box
        w = x2 - x1
        h = y2 - y1
        cx = x1 + w / 2
        cy = y1 + h / 2
        return torch.tensor([cx, cy, w, h])

    def cxcywh_to_xyxy(box):
        """(cx, cy, w, h) -> (x1, y1, x2, y2)"""
        cx, cy, w, h = box
        x1 = cx - w / 2
        y1 = cy - h / 2
        x2 = cx + w / 2
        y2 = cy + h / 2
        return torch.tensor([x1, y1, x2, y2])

    # ç¤ºä¾‹
    box_xyxy = torch.tensor([100.0, 50.0, 200.0, 150.0])
    box_cxcywh = xyxy_to_cxcywh(box_xyxy)

    print("ç¤ºä¾‹ï¼šè¾¹ç•Œæ¡†æ ¼å¼è½¬æ¢\n")
    print(f"xyxy æ ¼å¼: {box_xyxy.tolist()}")
    print(f"cxcywh æ ¼å¼: {box_cxcywh.tolist()}")

    # è½¬å›éªŒè¯
    box_back = cxcywh_to_xyxy(box_cxcywh)
    print(f"è½¬å› xyxy: {box_back.tolist()}")


# ==================== ç¬¬ä¸‰éƒ¨åˆ†ï¼šIoU è®¡ç®— ====================


def iou_calculation():
    """IoU è®¡ç®—"""
    print("\n" + "=" * 60)
    print("ç¬¬ä¸‰éƒ¨åˆ†ï¼šIoU (Intersection over Union)")
    print("=" * 60)

    print("""
IoU å®šä¹‰ï¼š

    IoU = äº¤é›†é¢ç§¯ / å¹¶é›†é¢ç§¯

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   é¢„æµ‹æ¡†    â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
    â”‚    â”‚///////â”‚    â”‚
    â”‚    â”‚/äº¤é›†//â”‚    â”‚
    â””â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
         â”‚   çœŸå®æ¡†   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    IoU èŒƒå›´: [0, 1]
    - IoU = 0: å®Œå…¨ä¸é‡å 
    - IoU = 1: å®Œå…¨é‡å 
    - IoU > 0.5: é€šå¸¸è®¤ä¸ºæ£€æµ‹æ­£ç¡®
    """)

    def calculate_iou(box1, box2):
        """
        è®¡ç®—ä¸¤ä¸ªè¾¹ç•Œæ¡†çš„ IoU

        Args:
            box1, box2: (x1, y1, x2, y2) æ ¼å¼
        """
        # è®¡ç®—äº¤é›†åŒºåŸŸ
        x1 = max(box1[0], box2[0])
        y1 = max(box1[1], box2[1])
        x2 = min(box1[2], box2[2])
        y2 = min(box1[3], box2[3])

        # äº¤é›†é¢ç§¯ (å¦‚æœä¸ç›¸äº¤åˆ™ä¸º0)
        intersection = max(0, x2 - x1) * max(0, y2 - y1)

        # å„è‡ªé¢ç§¯
        area1 = (box1[2] - box1[0]) * (box1[3] - box1[1])
        area2 = (box2[2] - box2[0]) * (box2[3] - box2[1])

        # å¹¶é›†é¢ç§¯
        union = area1 + area2 - intersection

        # IoU
        iou = intersection / union if union > 0 else 0

        return iou

    # ç¤ºä¾‹
    print("ç¤ºä¾‹ï¼šè®¡ç®— IoU\n")

    # æƒ…å†µ1: éƒ¨åˆ†é‡å 
    pred_box = [100, 100, 200, 200]
    gt_box = [150, 100, 250, 200]
    iou1 = calculate_iou(pred_box, gt_box)
    print(f"éƒ¨åˆ†é‡å : IoU = {iou1:.4f}")

    # æƒ…å†µ2: å®Œå…¨åŒ…å«
    pred_box2 = [100, 100, 300, 300]
    gt_box2 = [150, 150, 250, 250]
    iou2 = calculate_iou(pred_box2, gt_box2)
    print(f"å®Œå…¨åŒ…å«: IoU = {iou2:.4f}")

    # æƒ…å†µ3: ä¸é‡å 
    pred_box3 = [0, 0, 100, 100]
    gt_box3 = [200, 200, 300, 300]
    iou3 = calculate_iou(pred_box3, gt_box3)
    print(f"ä¸é‡å : IoU = {iou3:.4f}")

    # å¯è§†åŒ–
    visualize_iou(pred_box, gt_box, iou1)


def visualize_iou(pred_box, gt_box, iou):
    """å¯è§†åŒ– IoU"""
    fig, ax = plt.subplots(1, 1, figsize=(8, 6))

    # ç»˜åˆ¶è¾¹ç•Œæ¡†
    pred_rect = patches.Rectangle(
        (pred_box[0], pred_box[1]),
        pred_box[2] - pred_box[0],
        pred_box[3] - pred_box[1],
        linewidth=2,
        edgecolor="red",
        facecolor="red",
        alpha=0.3,
        label="é¢„æµ‹æ¡†",
    )
    gt_rect = patches.Rectangle(
        (gt_box[0], gt_box[1]),
        gt_box[2] - gt_box[0],
        gt_box[3] - gt_box[1],
        linewidth=2,
        edgecolor="green",
        facecolor="green",
        alpha=0.3,
        label="çœŸå®æ¡†",
    )

    ax.add_patch(pred_rect)
    ax.add_patch(gt_rect)

    ax.set_xlim(0, 350)
    ax.set_ylim(0, 300)
    ax.set_aspect("equal")
    ax.invert_yaxis()
    ax.set_title(f"IoU = {iou:.4f}")
    ax.legend()

    plt.savefig("iou_visualization.png", dpi=150, bbox_inches="tight")
    print("\nâœ“ IoU å¯è§†åŒ–å·²ä¿å­˜åˆ° iou_visualization.png")


# ==================== ç¬¬å››éƒ¨åˆ†ï¼šNMS éæå¤§å€¼æŠ‘åˆ¶ ====================


def nms_demo():
    """NMS æ¼”ç¤º"""
    print("\n" + "=" * 60)
    print("ç¬¬å››éƒ¨åˆ†ï¼šNMS (Non-Maximum Suppression)")
    print("=" * 60)

    print("""
NMS çš„ä½œç”¨ï¼š

    é—®é¢˜: åŒä¸€ç‰©ä½“å¯èƒ½äº§ç”Ÿå¤šä¸ªé‡å çš„æ£€æµ‹æ¡†

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ£€æµ‹ç»“æœ (NMS å‰)            NMS å                    â”‚
    â”‚  â”Œâ”€â”€â”€â”                       â”Œâ”€â”€â”€â”                     â”‚
    â”‚  â”‚â”Œâ”€â”€â”¼â”  0.9                 â”‚   â”‚  0.9               â”‚
    â”‚  â”‚â”‚ğŸ±â”‚â”‚  0.8     â”€â”€â”€â†’       â”‚ğŸ± â”‚  (ä¿ç•™æœ€é«˜åˆ†)        â”‚
    â”‚  â”‚â””â”€â”€â”¼â”˜  0.7                 â”‚   â”‚                     â”‚
    â”‚  â””â”€â”€â”€â”˜                       â””â”€â”€â”€â”˜                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NMS ç®—æ³•æ­¥éª¤ï¼š
    1. æŒ‰ç½®ä¿¡åº¦åˆ†æ•°æ’åºæ‰€æœ‰æ£€æµ‹æ¡†
    2. é€‰æ‹©åˆ†æ•°æœ€é«˜çš„æ¡†ï¼ŒåŠ å…¥ç»“æœ
    3. è®¡ç®—å…¶ä»–æ¡†ä¸è¯¥æ¡†çš„ IoU
    4. åˆ é™¤ IoU > é˜ˆå€¼çš„æ¡† (è®¤ä¸ºæ˜¯åŒä¸€ç‰©ä½“)
    5. é‡å¤æ­¥éª¤ 2-4ï¼Œç›´åˆ°å¤„ç†å®Œæ‰€æœ‰æ¡†
    """)

    def nms(boxes, scores, iou_threshold=0.5):
        """
        éæå¤§å€¼æŠ‘åˆ¶

        Args:
            boxes: [N, 4] è¾¹ç•Œæ¡† (x1, y1, x2, y2)
            scores: [N] ç½®ä¿¡åº¦åˆ†æ•°
            iou_threshold: IoU é˜ˆå€¼

        Returns:
            keep: ä¿ç•™çš„æ¡†çš„ç´¢å¼•
        """
        if len(boxes) == 0:
            return []

        # è½¬æ¢ä¸º numpy
        boxes = np.array(boxes)
        scores = np.array(scores)

        # æŒ‰åˆ†æ•°é™åºæ’åº
        indices = np.argsort(scores)[::-1]

        keep = []

        while len(indices) > 0:
            # é€‰æ‹©åˆ†æ•°æœ€é«˜çš„æ¡†
            current = indices[0]
            keep.append(current)

            if len(indices) == 1:
                break

            # è®¡ç®—å½“å‰æ¡†ä¸å…¶ä»–æ¡†çš„ IoU
            current_box = boxes[current]
            other_indices = indices[1:]
            other_boxes = boxes[other_indices]

            # è®¡ç®—äº¤é›†
            x1 = np.maximum(current_box[0], other_boxes[:, 0])
            y1 = np.maximum(current_box[1], other_boxes[:, 1])
            x2 = np.minimum(current_box[2], other_boxes[:, 2])
            y2 = np.minimum(current_box[3], other_boxes[:, 3])

            intersection = np.maximum(0, x2 - x1) * np.maximum(0, y2 - y1)

            # è®¡ç®—å„è‡ªé¢ç§¯
            area_current = (current_box[2] - current_box[0]) * (
                current_box[3] - current_box[1]
            )
            area_others = (other_boxes[:, 2] - other_boxes[:, 0]) * (
                other_boxes[:, 3] - other_boxes[:, 1]
            )

            # è®¡ç®— IoU
            union = area_current + area_others - intersection
            ious = intersection / union

            # ä¿ç•™ IoU < é˜ˆå€¼çš„æ¡†
            mask = ious < iou_threshold
            indices = other_indices[mask]

        return keep

    # ç¤ºä¾‹
    print("ç¤ºä¾‹ï¼šNMS åº”ç”¨\n")

    # æ¨¡æ‹Ÿæ£€æµ‹ç»“æœ (åŒä¸€ç‰©ä½“çš„å¤šä¸ªæ£€æµ‹æ¡†)
    boxes = [
        [100, 100, 200, 200],  # æ¡†1
        [105, 95, 205, 195],  # æ¡†2 (ä¸æ¡†1é«˜åº¦é‡å )
        [110, 105, 210, 205],  # æ¡†3 (ä¸æ¡†1ã€2é«˜åº¦é‡å )
        [300, 100, 400, 200],  # æ¡†4 (å¦ä¸€ç‰©ä½“)
        [305, 105, 405, 205],  # æ¡†5 (ä¸æ¡†4é‡å )
    ]
    scores = [0.9, 0.8, 0.7, 0.85, 0.6]

    print("NMS å‰:")
    for i, (box, score) in enumerate(zip(boxes, scores)):
        print(f"  æ¡†{i + 1}: {box}, åˆ†æ•°: {score}")

    keep = nms(boxes, scores, iou_threshold=0.5)

    print(f"\nNMS å (IoUé˜ˆå€¼=0.5):")
    print(f"  ä¿ç•™çš„æ¡†ç´¢å¼•: {keep}")
    for i in keep:
        print(f"  æ¡†{i + 1}: {boxes[i]}, åˆ†æ•°: {scores[i]}")


# ==================== ç¬¬äº”éƒ¨åˆ†ï¼šAnchor æœºåˆ¶ ====================


def anchor_demo():
    """Anchor æœºåˆ¶æ¼”ç¤º"""
    print("\n" + "=" * 60)
    print("ç¬¬äº”éƒ¨åˆ†ï¼šAnchor æœºåˆ¶")
    print("=" * 60)

    print("""
Anchor (å…ˆéªŒæ¡†) çš„ä½œç”¨ï¼š

    ç‰©ä½“å½¢çŠ¶å„å¼‚ï¼Œä½¿ç”¨é¢„å®šä¹‰çš„å…ˆéªŒæ¡†å¸®åŠ©å®šä½ã€‚

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ä¸åŒæ¯”ä¾‹çš„ Anchor:                                      â”‚
    â”‚                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”                        â”‚
    â”‚  â”‚   â”‚    â”‚           â”‚    â”‚  â”‚                        â”‚
    â”‚  â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚                        â”‚
    â”‚  â”‚   â”‚       1:2           â”‚  â”‚      2:1               â”‚
    â”‚  â””â”€â”€â”€â”˜                     â”‚  â”‚                        â”‚
    â”‚   1:1                      â”‚  â”‚                        â”‚
    â”‚                            â””â”€â”€â”˜                        â”‚
    â”‚                                                         â”‚
    â”‚  ä¸åŒå°ºåº¦çš„ Anchor:                                      â”‚
    â”‚                                                         â”‚
    â”‚  â”Œâ”€â”    â”Œâ”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”                               â”‚
    â”‚  â””â”€â”˜    â”‚   â”‚    â”‚     â”‚                               â”‚
    â”‚  å°     â”‚   â”‚    â”‚     â”‚                               â”‚
    â”‚         â””â”€â”€â”€â”˜    â”‚     â”‚                               â”‚
    â”‚          ä¸­      â””â”€â”€â”€â”€â”€â”˜                               â”‚
    â”‚                    å¤§                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç½‘ç»œé¢„æµ‹çš„æ˜¯ç›¸å¯¹äº Anchor çš„åç§»ï¼š
    tx, ty: ä¸­å¿ƒç‚¹åç§»
    tw, th: å®½é«˜ç¼©æ”¾ (å¯¹æ•°ç©ºé—´)

è§£ç å…¬å¼ï¼š
    bx = Ïƒ(tx) + cx  (cx, cy æ˜¯ç½‘æ ¼ä½ç½®)
    by = Ïƒ(ty) + cy
    bw = pw * e^tw   (pw, ph æ˜¯ Anchor å®½é«˜)
    bh = ph * e^th
    """)

    def generate_anchors(sizes=[32, 64, 128], ratios=[0.5, 1.0, 2.0]):
        """
        ç”Ÿæˆ Anchor

        Args:
            sizes: Anchor é¢ç§¯çš„å¹³æ–¹æ ¹
            ratios: å®½é«˜æ¯” (w/h)

        Returns:
            anchors: [N, 4] (cx=0, cy=0, w, h)
        """
        anchors = []
        for size in sizes:
            area = size * size
            for ratio in ratios:
                # w/h = ratio, w*h = area
                # w = sqrt(area * ratio)
                # h = sqrt(area / ratio)
                w = np.sqrt(area * ratio)
                h = np.sqrt(area / ratio)
                anchors.append([0, 0, w, h])
        return np.array(anchors)

    # ç”Ÿæˆå¹¶æ˜¾ç¤º Anchor
    print("\nç¤ºä¾‹ï¼šç”Ÿæˆ Anchor\n")

    anchors = generate_anchors()
    print("ç”Ÿæˆçš„ Anchor (cx, cy, w, h):")
    print(f"å°ºåº¦: [32, 64, 128], æ¯”ä¾‹: [0.5, 1.0, 2.0]")
    print(f"å…± {len(anchors)} ä¸ª Anchor:\n")

    for i, anchor in enumerate(anchors):
        print(f"  Anchor {i + 1}: w={anchor[2]:.1f}, h={anchor[3]:.1f}")


# ==================== ç¬¬å…­éƒ¨åˆ†ï¼šè¯„ä¼°æŒ‡æ ‡ ====================


def evaluation_metrics():
    """è¯„ä¼°æŒ‡æ ‡"""
    print("\n" + "=" * 60)
    print("ç¬¬å…­éƒ¨åˆ†ï¼šè¯„ä¼°æŒ‡æ ‡")
    print("=" * 60)

    print("""
ç›®æ ‡æ£€æµ‹è¯„ä¼°æŒ‡æ ‡ï¼š

1. ç²¾ç¡®ç‡ (Precision) å’Œ å¬å›ç‡ (Recall)ï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              å®é™…æ­£ä¾‹    å®é™…è´Ÿä¾‹                        â”‚
    â”‚  é¢„æµ‹æ­£ä¾‹       TP          FP                          â”‚
    â”‚  é¢„æµ‹è´Ÿä¾‹       FN          TN                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Precision = TP / (TP + FP)  â†’ é¢„æµ‹ä¸ºæ­£çš„æœ‰å¤šå°‘æ˜¯å¯¹çš„
    Recall = TP / (TP + FN)     â†’ å®é™…ä¸ºæ­£çš„æœ‰å¤šå°‘è¢«æ‰¾åˆ°äº†

2. AP (Average Precision)ï¼š

    PR æ›²çº¿ä¸‹é¢ç§¯
    - è®¾ç½®ä¸åŒç½®ä¿¡åº¦é˜ˆå€¼ï¼Œè®¡ç®—å¯¹åº”çš„ (Precision, Recall)
    - ç»˜åˆ¶ PR æ›²çº¿ï¼Œè®¡ç®—æ›²çº¿ä¸‹é¢ç§¯

3. mAP (mean Average Precision)ï¼š

    æ‰€æœ‰ç±»åˆ« AP çš„å¹³å‡å€¼
    mAP = (1/N) * Î£ AP_i

    å¸¸è§æ ‡å‡†:
    - mAP@0.5: IoU é˜ˆå€¼ = 0.5 æ—¶çš„ mAP
    - mAP@0.5:0.95: IoU ä» 0.5 åˆ° 0.95 æ­¥é•¿ 0.05 çš„å¹³å‡ mAP
    """)

    # æ¨¡æ‹Ÿè®¡ç®— AP
    print("ç¤ºä¾‹ï¼šè®¡ç®— AP\n")

    def calculate_ap(recalls, precisions):
        """è®¡ç®— AP (11-point interpolation)"""
        recalls = np.array(recalls)
        precisions = np.array(precisions)

        # åœ¨ 0, 0.1, 0.2, ..., 1.0 å¤„æ’å€¼
        ap = 0
        for t in np.arange(0, 1.1, 0.1):
            if np.sum(recalls >= t) == 0:
                p = 0
            else:
                p = np.max(precisions[recalls >= t])
            ap += p / 11

        return ap

    # æ¨¡æ‹Ÿ PR æ•°æ®
    recalls = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
    precisions = [1.0, 1.0, 0.95, 0.9, 0.85, 0.75, 0.65, 0.5, 0.3, 0.1]

    ap = calculate_ap(recalls, precisions)
    print(f"AP = {ap:.4f}")


# ==================== ç¬¬ä¸ƒéƒ¨åˆ†ï¼šç»ƒä¹ ä¸æ€è€ƒ ====================


def exercises():
    """ç»ƒä¹ é¢˜"""
    print("\n" + "=" * 60)
    print("ç»ƒä¹ ä¸æ€è€ƒ")
    print("=" * 60)

    print("""
ç»ƒä¹  1ï¼šIoU è®¡ç®—
    å®ç°æ‰¹é‡è®¡ç®— IoU çš„å‡½æ•°:
    def batch_iou(boxes1, boxes2):
        '''
        boxes1: [N, 4]
        boxes2: [M, 4]
        return: [N, M] IoU çŸ©é˜µ
        '''
        pass

ç»ƒä¹  2ï¼šNMS å˜ä½“
    å®ç° Soft-NMS:
    - ä¸æ˜¯ç›´æ¥åˆ é™¤é‡å æ¡†
    - è€Œæ˜¯é™ä½é‡å æ¡†çš„ç½®ä¿¡åº¦åˆ†æ•°

ç»ƒä¹  3ï¼šAnchor åŒ¹é…
    å®ç°å°†çœŸå®æ¡†ä¸ Anchor åŒ¹é…çš„å‡½æ•°:
    - IoU > 0.7: æ­£æ ·æœ¬
    - IoU < 0.3: è´Ÿæ ·æœ¬
    - å…¶ä»–: å¿½ç•¥

ç»ƒä¹  4ï¼šå¯è§†åŒ–æ£€æµ‹ç»“æœ
    ç¼–å†™å‡½æ•°åœ¨å›¾åƒä¸Šç»˜åˆ¶æ£€æµ‹æ¡†:
    - æ˜¾ç¤ºç±»åˆ«åç§°
    - æ˜¾ç¤ºç½®ä¿¡åº¦åˆ†æ•°
    - ä¸åŒç±»åˆ«ä½¿ç”¨ä¸åŒé¢œè‰²

æ€è€ƒé¢˜ 1ï¼šä¸ºä»€ä¹ˆéœ€è¦ NMSï¼Ÿ
    æœ‰æ²¡æœ‰ä¸ç”¨ NMS çš„æ–¹æ³•ï¼Ÿ

æ€è€ƒé¢˜ 2ï¼šAnchor çš„æ•°é‡å¦‚ä½•å½±å“æ£€æµ‹æ•ˆæœï¼Ÿ
    å¤ªå¤šæˆ–å¤ªå°‘ä¼šæ€æ ·ï¼Ÿ

æ€è€ƒé¢˜ 3ï¼šIoU æœ‰ä»€ä¹ˆå±€é™æ€§ï¼Ÿ
    GIoU, DIoU, CIoU æ˜¯å¦‚ä½•æ”¹è¿›çš„ï¼Ÿ
    """)


# ==================== ä¸»å‡½æ•° ====================


def main():
    """ä¸»å‡½æ•°"""
    introduction()
    bounding_box_basics()
    iou_calculation()
    nms_demo()
    anchor_demo()
    evaluation_metrics()
    exercises()

    print("\n" + "=" * 60)
    print("è¯¾ç¨‹å®Œæˆï¼")
    print("=" * 60)
    print("""
ä¸‹ä¸€æ­¥å­¦ä¹ ï¼š
    - 02-yolo-v8.py: YOLO ç³»åˆ—æ£€æµ‹å™¨

å…³é”®è¦ç‚¹å›é¡¾ï¼š
    âœ“ ç›®æ ‡æ£€æµ‹ = åˆ†ç±» + å®šä½
    âœ“ IoU è¡¡é‡é¢„æµ‹æ¡†ä¸çœŸå®æ¡†çš„é‡å ç¨‹åº¦
    âœ“ NMS å»é™¤å†—ä½™æ£€æµ‹æ¡†
    âœ“ Anchor æ˜¯é¢„å®šä¹‰çš„å…ˆéªŒæ¡†
    âœ“ mAP æ˜¯ç›®æ ‡æ£€æµ‹çš„ä¸»è¦è¯„ä¼°æŒ‡æ ‡
    """)


if __name__ == "__main__":
    main()
